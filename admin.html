<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindMirror Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { display: flex; font-family: "Segoe UI", sans-serif; background: #f0f2f5; color: #333; height: 100vh; }
    .sidebar {
      width: 240px;
      background: #1e2a38;
      color: #fff;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      z-index: 10;
    }
    .sidebar.collapsed { transform: translateX(-100%); }
    .sidebar .logo { font-size: 1.5em; font-weight: bold; text-align: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: #18202b; }
    .sidebar nav a { display: flex; align-items: center; padding: 15px 20px; text-decoration: none; color: #fff; transition: background 0.3s; }
    .sidebar nav a:hover { background: rgba(255,255,255,0.1); }
    .sidebar nav a i { margin-right: 10px; }
    .main { margin-left: 240px; flex: 1; padding: 30px; overflow-y: auto; transition: margin-left 0.3s ease; }
    .main h2 { color: #4a90e2; margin-bottom: 15px; }
    .main p { font-size: 1.1em; line-height: 1.6; }
    .hamburger {
      display: none;
      position: fixed;
      top: 15px;
      right: 15px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.5em;
      padding: 8px 12px;
      cursor: pointer;
      z-index: 20;
    }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .main { margin-left: 0; }
      .hamburger { display: block; }
    }
    /* question manager styles */
    .button { background: #4a90e2; color: white; border: none; padding: 8px 12px; border-radius: 5px; margin: 5px; cursor: pointer; }
    table { width:100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border:1px solid #ccc; padding:10px; }
    th { background:#eee; }
    .hidden { display:none; }
    input[type="text"] { width: 100%; padding:5px; margin:5px 0; }
  </style>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="sidebar" id="sidebar">
    <div class="logo">MindMirror Admin</div>
    <nav>
      <a href="#" onclick="loadDashboard()"><i class="ph ph-gauge"></i> Dashboard</a>
      <a href="#"><i class="ph ph-file-text"></i> Reports</a>
      <a href="#" onclick="loadQuestionManager()"><i class="ph ph-list-checks"></i> Questions</a>
      <a href="#" onclick="loadUserManager()"><i class="ph ph-users"></i> Users</a>
      <a href="javascript:void(0)" onclick="loadPreviewTest()"><i class="ph ph-eye"></i> Preview Test</a>
    </nav>
  </div>
  <div class="main" id="main-content">
    <h2>Welcome, Admin</h2>
    <p>Use the navigation on the left to manage your MindMirror app. This is your admin control panel.</p>
  </div>
  <script>
    let allQuestions = [];
window.currentPage = 1;

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }
    function loadDashboard(){
      document.getElementById("main-content").innerHTML = `
        <h2>Dashboard</h2>
        <p>This is your dashboard. (To be developed)</p>
      `;
    }
    function loadQuestionManager(){
  const content = document.getElementById("main-content");
  content.innerHTML = `
    <h2>Question Manager</h2>
    <input type="text" id="search-box" placeholder="Search..." oninput="renderQuestions()" style="padding:5px; width:200px;"/>
    <button class="button" onclick="showAddForm()">Add Question</button>
    <button class="button" onclick="deleteSelected()">Delete Selected</button>
    <input type="file" id="csvfile" accept=".csv" />
<button class="button" onclick="importCSV()">Import CSV</button>
    <table id="questions-table">
      <thead>
        <tr>
          <th style="text-align: center;">
  <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
</th>

          <th>Question</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pagination" style="margin-top:10px;"></div>
    <div id="question-form" class="hidden">
      <h3 id="form-title">Add Question</h3>
      <input type="hidden" id="qid" />
      <label>Question:</label>
      <input type="text" id="qtext" />
      <div>
        <label>Options:</label>
        <input type="text" id="opt1" value="Strongly Agree" />
        <input type="text" id="opt2" value="Agree" />
        <input type="text" id="opt3" value="Neutral" />
        <input type="text" id="opt4" value="Disagree" />
        <input type="text" id="opt5" value="Strongly Disagree" />
      </div>
      <button class="button" onclick="saveQuestion()">Save</button>
      <button class="button" onclick="hideForm()">Cancel</button>
    </div>
  `;
  window.currentPage = 1;
  loadQuestions();
}

    async function loadQuestions(){
  const res = await fetch('/api/questions');
  allQuestions = await res.json();
  renderQuestions();
}
function renderQuestions(){
  const tbody = document.querySelector("#questions-table tbody");
  const search = document.getElementById("search-box")?.value?.toLowerCase() || "";
  let filtered = allQuestions.filter(q => q.text.toLowerCase().includes(search));

  const perPage = window.innerWidth <= 768 ? 10 : 25;
  const page = window.currentPage || 1;
  const start = (page-1)*perPage;
  const pageItems = filtered.slice(start, start+perPage);

  tbody.innerHTML = pageItems.map(q=>`
    <tr>
      <td><input type="checkbox" class="select-q" value="${q.id}"></td>
      <td>${q.text}</td>
      <td><button class="button" onclick="editQuestion('${q.id}')">Edit</button></td>
    </tr>
  `).join("");

  renderPagination(filtered.length, perPage);
}
function renderPagination(total, perPage){
  const container = document.getElementById("pagination");
  if(!container) return;
  const pageCount = Math.ceil(total/perPage);
  let buttons = "";
  for(let i=1; i<=pageCount; i++){
    buttons += `<button class="button" onclick="goPage(${i})">${i}</button>`;
  }
  container.innerHTML = buttons;
}
function goPage(p){
  window.currentPage = p;
  renderQuestions();
}

    function toggleSelectAll(master){
      document.querySelectorAll(".select-q").forEach(cb => cb.checked = master.checked);
    }
    function showAddForm(){
      document.getElementById("question-form").classList.remove("hidden");
      document.getElementById("form-title").innerText = "Add Question";
      document.getElementById("qid").value = "";
      document.getElementById("qtext").value = "";
      document.getElementById("opt1").value = "Strongly Agree";
      document.getElementById("opt2").value = "Agree";
      document.getElementById("opt3").value = "Neutral";
      document.getElementById("opt4").value = "Disagree";
      document.getElementById("opt5").value = "Strongly Disagree";
    }
    function hideForm(){
      document.getElementById("question-form").classList.add("hidden");
    }
    async function saveQuestion(){
  const id = document.getElementById("qid").value;
  const text = document.getElementById("qtext").value;
  const options = [
    document.getElementById("opt1").value,
    document.getElementById("opt2").value,
    document.getElementById("opt3").value,
    document.getElementById("opt4").value,
    document.getElementById("opt5").value
  ];
  try {
    if(id){
      await fetch('/api/questions/update', {
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id,text,options})
      });
    } else {
      const res = await fetch('/api/questions/add', {
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text,options})
      });
      const data = await res.json();
      if(data.error){
        alert(data.error);
        return;
      }
    }
    hideForm();
    loadQuestions();
  } catch(err){
    alert("Error saving question.");
  }
}

    async function editQuestion(id){
      const res = await fetch('/api/questions');
      const data = await res.json();
      const q = data.find(x=>x.id===id);
      if(q){
        document.getElementById("qid").value = q.id;
        document.getElementById("qtext").value = q.text;
        document.getElementById("opt1").value = q.options[0]||"";
        document.getElementById("opt2").value = q.options[1]||"";
        document.getElementById("opt3").value = q.options[2]||"";
        document.getElementById("opt4").value = q.options[3]||"";
        document.getElementById("opt5").value = q.options[4]||"";
        document.getElementById("form-title").innerText = "Edit Question";
        document.getElementById("question-form").classList.remove("hidden");
      }
    }
    async function deleteSelected(){
      const ids = Array.from(document.querySelectorAll(".select-q:checked")).map(cb => cb.value);
      if(ids.length===0) return alert("Nothing selected");
      if(!confirm("Delete selected?")) return;
      await fetch('/api/questions/delete', {
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ids})
      });
      loadQuestions();
    }

    function loadUserManager(){
  const content = document.getElementById("main-content");
  content.innerHTML = `
    <h2>User Manager</h2>
    <table id="users-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Admin</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  `;
  loadUsers();
}

async function loadUsers(){
  const res = await fetch('/api/users');
  const data = await res.json();
  const tbody = document.querySelector("#users-table tbody");
  tbody.innerHTML = data.map(u => `
    <tr>
      <td>${u.email}</td>
      <td>${u.displayName}</td>
      <td>${u.admin ? 'Yes' : 'No'}</td>
      <td>
        ${!u.admin ? `<button class="button" onclick="promoteUser('${u.uid}')">Promote</button>` : ''}
        <button class="button" onclick="deleteUser('${u.uid}')">Delete</button>
      </td>
    </tr>
  `).join("");
}

async function promoteUser(uid){
  if(!confirm("Make this user admin?")) return;
  await fetch('/api/users/promote', {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ uid })
  });
  loadUsers();
}

async function deleteUser(uid){
  if(!confirm("Delete this user?")) return;
  await fetch('/api/users/delete', {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ uid })
  });
  loadUsers();
}

async function importCSV(){
  const fileInput = document.getElementById("csvfile");
  if(fileInput.files.length === 0){
    alert("Please select a CSV file");
    return;
  }
  const file = fileInput.files[0];
  const text = await file.text();
  const rows = text.split("\n").map(line => line.trim()).filter(l => l.length>0);
  const data = [];
  for(const row of rows){
    const parts = row.split(",");
    if(parts.length >= 1){
      data.push({
        text: parts[0],
        options: parts.slice(1).length > 0 ? parts.slice(1) : [
          "Strongly Agree","Agree","Neutral","Disagree","Strongly Disagree"
        ]
      });
    }
  }
  const res = await fetch('/api/questions/import', {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({questions: data})
  });
  if(res.ok){
    alert("Import completed!");
    loadQuestions();
  } else {
    alert("Import failed.");
  }
}

function loadUserManager(){
  const content = document.getElementById("main-content");
content.innerHTML = `
  <h2>User Manager</h2>
  <div style="margin-bottom:15px;">
    <input type="text" id="user-search" placeholder="Search..." oninput="renderUsers()" style="padding:8px;width:100%;max-width:250px;border:1px solid #ccc;border-radius:4px;">
    <button class="button" style="margin-left:10px;" onclick="showAddUserForm()">Add User</button>
  </div>
  <div style="overflow-x:auto;">
    <table id="user-table" style="width:100%;border-collapse:collapse;table-layout:fixed;">
      <thead style="background:#4a90e2;color:black;">
        <tr>
          <th style="padding:10px;border:1px solid #ddd;">Name</th>
          <th style="padding:10px;border:1px solid #ddd;">Email</th>
          <th style="padding:10px;border:1px solid #ddd;">Created At</th>
          <th style="padding:10px;border:1px solid #ddd;">Evaluation</th>
          <th style="padding:10px;border:1px solid #ddd;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="user-pagination" style="margin-top:10px;"></div>
  <div id="user-form" class="hidden" style="background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;max-width:400px;margin-top:20px;">
    <h3 id="user-form-title">Add User</h3>
    <div style="margin-bottom:10px;">
      <label>Name:</label>
      <input type="text" id="newname" style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Email:</label>
      <input type="email" id="newemail" style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Password:</label>
      <input type="password" id="newpassword" style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Confirm Password:</label>
      <input type="password" id="confirmpassword" style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Role:</label>
      <select id="role" style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;">
        <option value="regular">Regular</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <button class="button" style="background:#4a90e2;color:white;" onclick="saveNewUser()">Save</button>
    <button class="button" style="background:#ccc;margin-left:10px;" onclick="hideAddUserForm()">Cancel</button>
  </div>
  <style>
    #user-table td, #user-table th {
      word-break: break-all;
      font-size: 0.9em;
    }
    @media(max-width: 768px){
      #user-table th, #user-table td {
        font-size: 0.8em;
      }
    }
  </style>
`;

  window.currentUserPage = 1;
  loadUsers();
}

let allUsers = [];

async function loadUsers(){
  const res = await fetch('/api/users');
  allUsers = await res.json();
  renderUsers();
}

function renderUsers(){
  const tbody = document.querySelector("#user-table tbody");
  const search = document.getElementById("user-search").value.toLowerCase();
  let filtered = allUsers.filter(u => 
  (u.name || '').toLowerCase().includes(search) || 
  (u.email || '').toLowerCase().includes(search)
);


  const perPage = window.innerWidth <= 768 ? 10 : 25;
  const page = window.currentUserPage || 1;
  const start = (page-1)*perPage;
  const pageItems = filtered.slice(start, start+perPage);

  tbody.innerHTML = pageItems.map(u=>`
    <tr>
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td>${new Date(u.createdAt).toLocaleString()}</td>
      <td>Pending</td>
      <td>
        <button class="button" onclick="editUser('${u.uid}')">Edit</button>
        <button class="button" onclick="deleteUser('${u.uid}')">Delete</button>
        <button class="button" onclick="toggleDisable('${u.uid}', ${u.disabled})">${u.disabled?'Enable':'Disable'}</button>
      </td>
    </tr>
  `).join("");

  renderUserPagination(filtered.length, perPage);
}

function renderUserPagination(total, perPage){
  const container = document.getElementById("user-pagination");
  const pageCount = Math.ceil(total/perPage);
  let buttons = "";
  for(let i=1; i<=pageCount; i++){
    buttons += `<button class="button" onclick="goUserPage(${i})">${i}</button>`;
  }
  container.innerHTML = buttons;
}

function goUserPage(p){
  window.currentUserPage = p;
  renderUsers();
}

async function editUser(uid){
  const user = allUsers.find(u=>u.uid===uid);
  if(!user) return;
  const name = prompt("New name", user.name);
  const email = prompt("New email", user.email);
  if(name && email){
    await fetch('/api/users/update', {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({uid, name, email})
    });
    loadUsers();
  }
}

async function deleteUser(uid){
  if(confirm("Are you sure you want to delete this user?")){
    await fetch('/api/users/delete', {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({uid})
    });
    loadUsers();
  }
}

async function toggleDisable(uid, disabled){
  await fetch('/api/users/disable', {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({uid, disable: !disabled})
  });
  loadUsers();
}
function showAddUserForm(){
  document.getElementById("user-form").classList.remove("hidden");
}
function hideAddUserForm(){
  document.getElementById("user-form").classList.add("hidden");
}
async function saveNewUser(){
  const name = document.getElementById("newname").value;
  const email = document.getElementById("newemail").value;
  const password = document.getElementById("newpassword").value;
  const confirm = document.getElementById("confirmpassword").value;
  const role = document.getElementById("role").value;

  if(!name || !email || !password || !confirm){
    alert("Please fill all fields");
    return;
  }
  if(password !== confirm){
    alert("Passwords do not match");
    return;
  }

  const res = await fetch('/api/users/add', {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name, email, password, role})
  });
  if(res.ok){
    alert("User created!");
    hideAddUserForm();
    loadUsers();
  } else {
    const err = await res.text();
    alert("Error: "+err);
  }
}

async function loadPreviewTest() {
  const content = document.querySelector(".main");
  content.innerHTML = `
    <style>
      #progress-container {
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        background: #f0f2f5;
        padding: 10px;
        z-index: 1000;
      }
      #progress-bar {
        background: #4a90e2;
        height: 20px;
        width: 0%;
        border-radius: 10px;
        transition: width 0.3s ease;
      }
      #progress-text {
        margin-top:5px;
        font-size:0.9em;
      }
      .question-block {
        margin-top:60px;
        margin-bottom:20px;
        padding:15px;
        background:#fff;
        border:1px solid #ddd;
        border-radius:8px;
      }
      .options-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .options-group label {
        flex: 1 1 150px;
        background:#f5f5f5;
        border:1px solid #ccc;
        border-radius:5px;
        padding:8px;
        text-align:center;
        cursor:pointer;
      }
      @media(max-width: 768px){
        #progress-container {
          left: 0;
        }
        .options-group {
          flex-direction: column;
        }
        .options-group label {
          flex: 1 1 100%;
        }
      }
    </style>
    <div id="progress-container">
      <div style="background:#ddd;width:100%;height:20px;border-radius:10px;">
        <div id="progress-bar"></div>
      </div>
      <div id="progress-text">0% completed</div>
    </div>
    <form id="test-form" style="margin-top:60px;"></form>
  `;

  try {
    const res = await fetch('/api/questions');
    const questions = await res.json();
    const form = document.getElementById("test-form");

    questions.forEach((q, idx) => {
      const block = document.createElement("div");
      block.className = "question-block";
      block.innerHTML = `
        <strong>${idx + 1}. ${q.text}</strong>
        <div class="options-group">
          ${q.options.map((opt, i) => `
            <label>
              <input type="radio" name="q${idx}" value="${opt}" onchange="updateProgress()"/> ${opt}
            </label>
          `).join("")}
        </div>
      `;
      form.appendChild(block);
    });
  } catch(err) {
    console.error(err);
    content.innerHTML += `<p>Error loading questions</p>`;
  }
}

function updateProgress() {
  const total = document.querySelectorAll("#test-form fieldset, #test-form strong").length;
  const answered = document.querySelectorAll("#test-form input:checked").length;
  const percent = Math.round((answered/total)*100);
  document.getElementById("progress-bar").style.width = percent+"%";
  document.getElementById("progress-text").textContent = `${percent}% completed`;
}

async function loadDashboard() {
  const content = document.querySelector(".main");
  content.innerHTML = `
    <style>
      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }
      .card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
      }
      .card h3 {
        margin-top: 0;
        color: #4a90e2;
      }
      .card p {
        font-size: 2em;
        margin: 10px 0;
      }
      @media(max-width:768px){
        .dashboard-cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <h2>Dashboard</h2>
    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Users</h3>
        <p id="total-users">0</p>
      </div>
      <div class="card">
        <h3>Total Questions</h3>
        <p id="total-questions">0</p>
      </div>
      <div class="card">
        <h3>Total Attempts</h3>
        <p id="total-attempts">0</p>
      </div>
      <div class="card">
        <h3>Feedback</h3>
        <p id="feedback-count">0</p>
      </div>
      <div class="card">
        <h3>Role Breakdown</h3>
        <p id="role-breakdown">Loading...</p>
      </div>
      <div class="card">
        <h3>Firestore Status</h3>
        <p id="firestore-status">Checking...</p>
      </div>
    </div>
  `;

  // load live data
  try {
    const usersSnap = await fetch('/api/users');
    const users = await usersSnap.json();
    document.getElementById("total-users").textContent = users.length;

    const questionsSnap = await fetch('/api/questions');
    const questions = await questionsSnap.json();
    document.getElementById("total-questions").textContent = questions.length;

    // test attempts placeholder:
    document.getElementById("total-attempts").textContent = "N/A"; // plug in later when you track attempts

    // feedback placeholder:
    document.getElementById("feedback-count").textContent = "0"; // change when you store feedback

    // role breakdown
    const roleCount = users.reduce((acc,u)=>{
      if(u.role==='admin') acc.admin++;
      else acc.regular++;
      return acc;
    },{admin:0,regular:0});
    document.getElementById("role-breakdown").textContent = 
      `Admins: ${roleCount.admin}, Regular: ${roleCount.regular}`;

    // firestore status
    document.getElementById("firestore-status").textContent = "Connected";

  } catch (err) {
    console.error(err);
    document.getElementById("firestore-status").textContent = "Error connecting";
  }
}
fetch('/api/stats')
  .then(response => response.json())
  .then(data => {
    document.getElementById('total-attempts').textContent = data.totalAttempts;
  })
  .catch(err => console.error(err));

  </script>
</body>
</html>
